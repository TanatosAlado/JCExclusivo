<div class="container mt-5 despacho-layout">

  <!-- ===========================
       PANTALLA INICIAL: SUCURSALES
       =========================== -->
  <div *ngIf="!selectedSucursal" class="row">
    <div class="col-12 mb-3">
      <h4>SeleccionÃ¡ la sucursal</h4>
      <p class="text-muted">ElegÃ­ desde quÃ© sucursal vas a operar en el punto de venta.</p>
    </div>

    <div *ngIf="sucursales.length === 0" class="col-12">
      <div class="alert alert-info">No hay sucursales registradas.</div>
    </div>

    <div class="col-md-4 mb-3" *ngFor="let suc of sucursales">
      <div class="card h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ suc.nombre || 'Sucursal sin nombre' }}</h5>
          <p class="card-text mb-1"><strong>DirecciÃ³n:</strong> {{ suc.direccion || '-' }}</p>
          <p class="card-text mb-3"><strong>Tel:</strong> {{ suc.telefono || '-' }}</p>

          <div class="mt-auto d-flex gap-2">
            <button class="btn btn-primary btn-sm" (click)="seleccionarSucursal(suc)">Seleccionar</button>
            <button class="btn btn-outline-secondary btn-sm" (click)="abrirCaja(suc.id)">Abrir caja</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===========================
       PANTALLA POS: mostrarse luego de elegir sucursal
       =========================== -->
  <div *ngIf="selectedSucursal" class="row">

    <div class="col-12 mb-3 d-flex justify-content-between align-items-center">
      <div>
        <h4>POS - {{ selectedSucursal.nombre }}</h4>
        <small class="text-muted">Sucursal: {{ selectedSucursal.direccion || '-' }}</small>
      </div>
      <div>
        <button class="btn btn-sm btn-outline-secondary me-2" (click)="cambiarSucursal()">Cambiar sucursal</button>
        <span *ngIf="!cajaActiva" class="badge bg-warning text-dark">Caja no abierta</span>
        <span *ngIf="cajaActiva" class="badge bg-success">Caja abierta ({{ cajaActiva.id }})</span>
      </div>
    </div>

    <!-- ðŸ“ Columna izquierda: bÃºsqueda y catÃ¡logo -->
    <div class="col-md-6 p-3 border-end">

      <!-- Buscar cliente (opcional) -->
      <div class="mb-3">
        <label class="form-label">Buscar cliente por DNI (opcional)</label>
        <div class="input-group">
          <input type="text" class="form-control" #dniInput placeholder="Ingrese DNI">
          <button class="btn btn-primary" (click)="buscarClientePorDNI(dniInput.value)">Buscar</button>
        </div>
        <div *ngIf="clienteActual" class="mt-2 alert alert-success p-2">
          Cliente: <strong>{{ clienteActual.nombre }}</strong> - Tipo: {{ clienteActual.tipo }}
        </div>
      </div>

      <hr>

      <!-- Escaneo cÃ³digo de barras -->
      <div class="mb-3">
        <label class="form-label">Escanear cÃ³digo de barras</label>
        <input type="text" class="form-control" #codigoInput placeholder="Escanee el producto"
          (keyup.enter)="procesarCodigoBarras(codigoInput.value); codigoInput.value=''" autofocus>
      </div>

      <!-- BÃºsqueda manual (solo si no se encontrÃ³ producto) -->
      <div *ngIf="modoBusquedaManual" class="mt-3">
        <label class="form-label">BÃºsqueda manual</label>
        <input type="text" class="form-control" [(ngModel)]="busquedaManual" (ngModelChange)="filtrarProductos()"
          placeholder="Buscar producto...">
        <!-- Lista de resultados -->
        <div *ngIf="busquedaManual.length > 2" class="mt-2">
          <!-- AquÃ­ irÃ­a el *ngFor de productos filtrados desde Firebase -->
          <button class="btn btn-sm btn-outline-primary me-2" *ngFor="let prod of productosFiltrados"
            (click)="agregarAlCarrito(prod, true)">
            {{ prod.descripcion }}
          </button>
        </div>
      </div>

    </div>

    <!-- ðŸ“ Columna derecha: carrito -->
    <div class="col-md-6 p-3">

      <h5>ðŸ›’ Carrito</h5>

      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Producto</th>
            <th style="width: 100px;">Cant.</th>
            <th style="width: 120px;">Precio</th>
            <th style="width: 120px;">Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of carrito; let i = index">
            <td>{{ item.nombre }}</td>
            <td>
              <input type="number" class="form-control form-control-sm" [(ngModel)]="item.cantidad" min="1"
                (change)="editarCantidad(i, item.cantidad)">
            </td>
            <td>
              <input type="number" class="form-control form-control-sm" [(ngModel)]="item.precioUnitario" min="0"
                (change)="editarPrecio(i, item.precioUnitario)">
            </td>
            <td>${{ item.subtotal | number:'1.2-2' }}</td>
            <td>
              <button class="btn btn-sm btn-danger" (click)="eliminarDelCarrito(i)">ðŸ—‘</button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- MÃ©todo de pago -->
      <div class="mt-3">
        <label class="form-label"><strong>MÃ©todo de pago</strong></label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="metodoPago" id="efectivo" value="efectivo"
            [(ngModel)]="metodoPago" (ngModelChange)="mostrarErrorPago=false">
          <label class="form-check-label" for="efectivo">Efectivo</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="metodoPago" id="tarjeta" value="tarjeta"
            [(ngModel)]="metodoPago" (ngModelChange)="mostrarErrorPago=false">
          <label class="form-check-label" for="tarjeta">Tarjeta</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="metodoPago" id="transferencia" value="transferencia"
            [(ngModel)]="metodoPago" (ngModelChange)="mostrarErrorPago=false">
          <label class="form-check-label" for="transferencia">Transferencia</label>
        </div>

        <!-- âš ï¸ Mensaje si no selecciona -->
        <div *ngIf="mostrarErrorPago" class="text-danger mt-2">
          Debe seleccionar un mÃ©todo de pago antes de continuar.
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <h4>Total: ${{ total | number:'1.2-2' }}</h4>
        <div>
          <button class="btn btn-secondary me-2" (click)="carrito=[]; total=0">Cancelar</button>
          <button class="btn btn-success" (click)="finalizarVenta()" [disabled]="carrito.length === 0">
            Finalizar Venta
          </button>
        </div>
      </div>

    </div>

  </div>
</div>
