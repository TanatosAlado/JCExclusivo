<div class="container mt-5 despacho-layout">
  <div class="row">

    <!-- 📍 Columna izquierda: búsqueda y catálogo -->
    <div class="col-md-6 p-3 border-end">

      <!-- Buscar cliente (opcional) -->
      <div class="mb-3">
        <label class="form-label">Buscar cliente por DNI (opcional)</label>
        <div class="input-group">
          <input type="text" class="form-control" #dniInput placeholder="Ingrese DNI">
          <button class="btn btn-primary" (click)="buscarClientePorDNI(dniInput.value)">Buscar</button>
        </div>
        <div *ngIf="clienteActual" class="mt-2 alert alert-success p-2">
          Cliente: <strong>{{ clienteActual.nombre }}</strong> - Tipo: {{ clienteActual.tipo }}
        </div>
      </div>

      <hr>

      <!-- Escaneo código de barras -->
      <div class="mb-3">
        <label class="form-label">Escanear código de barras</label>
        <input type="text" class="form-control" #codigoInput placeholder="Escanee el producto"
          (keyup.enter)="procesarCodigoBarras(codigoInput.value); codigoInput.value=''" autofocus>
      </div>

      <!-- Búsqueda manual (solo si no se encontró producto) -->
      <div *ngIf="modoBusquedaManual" class="mt-3">
        <label class="form-label">Búsqueda manual</label>
        <input type="text" class="form-control" [(ngModel)]="busquedaManual" (ngModelChange)="filtrarProductos()"
          placeholder="Buscar producto...">
        <!-- Lista de resultados -->
        <div *ngIf="busquedaManual.length > 2" class="mt-2">
          <!-- Aquí iría el *ngFor de productos filtrados desde Firebase -->
          <button class="btn btn-sm btn-outline-primary me-2" *ngFor="let prod of productosFiltrados"
            (click)="agregarAlCarrito(prod, true)">
            {{ prod.descripcion }}
          </button>
        </div>
      </div>

    </div>

    <!-- 📍 Columna derecha: carrito -->
    <div class="col-md-6 p-3">

      <h5>🛒 Carrito</h5>

      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Producto</th>
            <th style="width: 100px;">Cant.</th>
            <th style="width: 120px;">Precio</th>
            <th style="width: 120px;">Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of carrito; let i = index">
            <td>{{ item.nombre }}</td>
            <td>
              <input type="number" class="form-control form-control-sm" [(ngModel)]="item.cantidad" min="1"
                (change)="editarCantidad(i, item.cantidad)">
            </td>
            <td>
              <input type="number" class="form-control form-control-sm" [(ngModel)]="item.precioUnitario" min="0"
                (change)="editarPrecio(i, item.precioUnitario)">
            </td>
            <td>${{ item.subtotal | number:'1.2-2' }}</td>
            <td>
              <button class="btn btn-sm btn-danger" (click)="eliminarDelCarrito(i)">🗑</button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Método de pago -->
      <div class="mt-3">
        <label class="form-label"><strong>Método de pago</strong></label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="metodoPago" id="efectivo" value="efectivo"
            [(ngModel)]="metodoPago" (ngModelChange)="mostrarErrorPago=false">
          <label class="form-check-label" for="efectivo">Efectivo</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="metodoPago" id="tarjeta" value="tarjeta"
            [(ngModel)]="metodoPago" (ngModelChange)="mostrarErrorPago=false">
          <label class="form-check-label" for="tarjeta">Tarjeta</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="metodoPago" id="transferencia" value="transferencia"
            [(ngModel)]="metodoPago" (ngModelChange)="mostrarErrorPago=false">
          <label class="form-check-label" for="transferencia">Transferencia</label>
        </div>

        <!-- ⚠️ Mensaje si no selecciona -->
        <div *ngIf="mostrarErrorPago" class="text-danger mt-2">
          Debe seleccionar un método de pago antes de continuar.
        </div>
      </div>


      <div class="d-flex justify-content-between align-items-center mt-3">
        <h4>Total: ${{ total | number:'1.2-2' }}</h4>
        <div>
          <button class="btn btn-secondary me-2" (click)="carrito=[]; total=0">Cancelar</button>
          <button class="btn btn-success" (click)="finalizarVenta()" [disabled]="carrito.length === 0">
            Finalizar Venta
          </button>
        </div>
      </div>

    </div>

  </div>
</div>